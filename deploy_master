# server-side deployment update

- pull changes
- install new libs `npm install --production`
- `sudo systemctl restart inventaire-alt`
- check if everything is fine: `journalctl -u inventaire-alt -af`
- `sudo systemctl restart inventaire`

# client side 

- compile elsewhere to not overcrowd production server cpu 
- cd /local/path/to/inventaire/client && npm run build
- `rsync -avz ~/local/path/to/inventaire/client/public invprod:~/inventaire/client`
- `find client/public -type f -mtime +30 -exec rm -f {} \;`

## Maintenance

### Reset human tasks

- https://github.com/inventaire/inventaire/blob/master/docs/leveldb_operations.md#delete-entries-in-bulk
  - `"[credentials]/tasks-prod/_design/tasks/_view/byEntitiesType?include_docs=true"  -d '{"key":"human"}'|jq '.rows[].doc|._deleted=true' -cr > /tmp/tasks_delete`
- `cat /tmp/tasks_delete | couchdb-bulk2 "[credentials]/tasks-prod"`
- curljson -XPOST "https://[credentials]@inventaire.io/api/tasks?action=collect-entities"

### i18n

- `cd inventaire/client/inventaire-i18n`
=> Make sure weblate remote exists: `git remote add weblate https://weblate.framasoft.org/git/inventaire/server/`

#### Update
/!\  Weblate do not work well with force push branches, prefer giving weblate branches priority:
- `git fetch weblate main && git checkout weblate/main && git checkout -B main`
- commit on main server branch
- `./scripts/reorder/reorder_all_resources`
- `git push origin main`
=> weblate hooks will take over updates
- `cd inventaire/client`
=> compile and push client
